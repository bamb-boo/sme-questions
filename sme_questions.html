<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IGCSE Question-Maker</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <h1>IGCSE Question-Maker</h1>

    <form id="question-form" onsubmit="calculate(event)">
        <div class="input-group">
            <label for="user_marks">Marks Scored:</label>
            <input type="number" id="user_marks" name="user_marks" min="0" required>
        </div>
        <div class="input-group">
            <label for="total_marks">Total Marks:</label>
            <input type="number" id="total_marks" name="total_marks" min="1" required>
        </div>
        <button type="submit" class="btn">Submit</button>
    </form>

    <div id="demo" class="result-box"></div>
    <div id="question-container" class="question-box"></div>
    <div id="marking-scheme-container" class="marking-box" style="display: none; margin-top: 10px;"></div>
</div>

<script>
let allData = [];
let currentQuestion = null;
const shownQuestions = {};

async function loadFirstQuestion() {
    try {
        const response = await fetch("questions1.json");
        allData = await response.json();

        if (allData.length === 0) {
            document.getElementById("question-container").innerHTML = `<p class="error">⚠ No questions found!</p>`;
            return;
        }

        // Start with the hardest question
        const maxHardness = Math.max(...allData.map(q => q.hardness));
        currentQuestion = allData.find(q => q.hardness === maxHardness);

        renderQuestion(currentQuestion);
    } catch (error) {
        console.error("Error loading questions:", error);
        document.getElementById("question-container").innerHTML = `<p class="error">⚠ Error loading question data</p>`;
    }
}

function renderQuestion(question) {
    const questionContainer = document.getElementById("question-container");
    const markingSchemeContainer = document.getElementById("marking-scheme-container");

    questionContainer.innerHTML = `
        <h3>Question ID: ${question.id}</h3>
        ${question.images.map(img => `<img src="${img}" alt="Question" class="question-img">`).join("")}
    `;

    markingSchemeContainer.style.display = "block";
    markingSchemeContainer.innerHTML = `
        <button id="marking-scheme-btn" class="btn">View Marking Scheme</button>
        <div id="marking-scheme-img" style="display:none; margin-top: 10px;">
            ${question.marking_scheme.map(img => `<img src="${img}" alt="Marking Scheme" class="question-img">`).join("")}
        </div>
    `;

    const btn = document.getElementById("marking-scheme-btn");
    const schemeImg = document.getElementById("marking-scheme-img");
    btn.onclick = () => {
        schemeImg.style.display = schemeImg.style.display === "none" ? "block" : "none";
    };
}

async function calculate(event) {
    event.preventDefault();
    const user_marks = Number(document.getElementById("user_marks").value);
    const totalMarks = Number(document.getElementById("total_marks").value);

    if (!currentQuestion) return;

    const demoBox = document.getElementById("demo");
    const questionContainer = document.getElementById("question-container");
    const markingSchemeContainer = document.getElementById("marking-scheme-container");

    if (user_marks > totalMarks) {
        demoBox.innerHTML = `<p class="error">⚠ Marks scored cannot exceed total marks (${totalMarks})!</p>`;
        return;
    }

    try {
        const hardness = currentQuestion.hardness;
        let increase_threshold = Math.max(1, Math.round(totalMarks * 0.15));
        let same_threshold = Math.max(1, Math.round(totalMarks * 0.30));
        let recommended_hardness;

        if (user_marks >= totalMarks - increase_threshold) {
            let performance_boost = (user_marks - (totalMarks - increase_threshold)) / totalMarks;
            recommended_hardness = hardness + 1 + performance_boost * 2;
        } else if (user_marks >= totalMarks - same_threshold) {
            recommended_hardness = hardness;
        } else {
            let performance_ratio = user_marks / totalMarks;
            recommended_hardness = hardness * (0.5 + 0.5 * performance_ratio);
        }

        let marks_weight = Math.log2(totalMarks + 1) / 3;
        recommended_hardness *= marks_weight;
        recommended_hardness = Math.round(Math.max(1, Math.min(5, recommended_hardness))); // clamp 1-5

        demoBox.innerHTML = `<p>Recommended Hardness: <b>${recommended_hardness}</b></p>`;

        const questionsByHardness = allData.filter(q => q.hardness === recommended_hardness);
        if (questionsByHardness.length === 0) {
            questionContainer.innerHTML = `<p class="error">⚠ No question found for hardness level ${recommended_hardness}</p>`;
            markingSchemeContainer.style.display = "none";
            return;
        }

        if (!shownQuestions[recommended_hardness]) shownQuestions[recommended_hardness] = [];
        const nextQuestion = questionsByHardness.find(q => !shownQuestions[recommended_hardness].includes(q.id));

        if (!nextQuestion) {
            shownQuestions[recommended_hardness] = [];
            questionContainer.innerHTML = `<p class="error">⚠ All questions for hardness ${recommended_hardness} have been shown. Resetting...</p>`;
            markingSchemeContainer.style.display = "none";
            return;
        }

        shownQuestions[recommended_hardness].push(nextQuestion.id);
        currentQuestion = nextQuestion;

        renderQuestion(nextQuestion);

    } catch (error) {
        console.error("Error in calculation:", error);
        questionContainer.innerHTML = `<p class="error">⚠ Error calculating next question</p>`;
        markingSchemeContainer.style.display = "none";
    }
}

// Load hardest question on page load
loadFirstQuestion();
</script>
</body>
</html>
